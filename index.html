<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONETECH - Sistema de Ponto de Venda e Serviços Pro</title>
    <link rel="icon" type="image/x-icon" href="image/onetech.ico">
    <!-- Meta tags para iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ONETECH">
    <link rel="apple-touch-icon" href="image/logo-onetech.png">
    <!-- Carregamento do Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <!-- App Loader -->
    <script>
        // Gera um token de acesso temporário
        window.APP_TOKEN = btoa(Date.now().toString());
    </script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm'
        
        // Inicialização do cliente Supabase
        const supabaseUrl = 'https://qghjrmnmsifvfzldeezw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFnaGpybW5tc2lmdmZ6bGRlZXp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MzgxMzMsImV4cCI6MjA3NjMxNDEzM30.ka1W83KCn1YvWYNH21xl1Wrck26T_oqvU0VH_biwkCI';
        
        // Cria o cliente Supabase
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Torna o cliente Supabase disponível globalmente
        window.supabase = supabase;

        // Função para testar a conexão
        async function testConnection() {
            try {
                const { data, error } = await supabase.from('models').select('*');
                if (error) throw error;
                console.log('Conexão com Supabase estabelecida com sucesso!');
            } catch (error) {
                console.error('Erro ao conectar com Supabase:', error);
            }
        }

        // Testa a conexão quando o módulo for carregado
        testConnection();
    </script>

    <!-- Configurações do Tailwind e outras bibliotecas -->
    <script>
        // Garante que o Supabase está disponível globalmente
        if (!window.supabase) {
            const supabaseUrl = 'https://qghjrmnmsifvfzldeezw.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFnaGpybW5tc2lmdmZ6bGRlZXp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MzgxMzMsImV4cCI6MjA3NjMxNDEzM30.ka1W83KCn1YvWYNH21xl1Wrck26T_oqvU0VH_biwkCI';
            window.supabase = createClient(supabaseUrl, supabaseKey);
        }

        // Funções de acesso ao Supabase
        async function getData() {
            try {
                const [
                    { data: orders }, 
                    { data: stock },
                    { data: models },
                    { data: services }
                ] = await Promise.all([
                    supabase.from('orders').select('*, order_services(*)').order('created_at', { ascending: false }),
                    supabase.from('stock').select('*'),
                    supabase.from('models').select('*'),
                    supabase.from('services').select('*')
                ]);

                return {
                    orders: orders || [],
                    stock: stock || [],
                    models: models || [],
                    services: services || [],
                    appData: {
                        revenueLog: await generateRevenueLog()
                    }
                };
            } catch (error) {
                console.error('Error fetching data:', error);
                showToast('Erro ao carregar dados do servidor', 'danger');
                return { orders: [], stock: [], models: [], services: [], appData: { revenueLog: [] } };
            }
        }

        async function saveOrder(orderData) {
            try {
                const { data: order, error: orderError } = await supabase
                    .from('orders')
                    .insert([{
                        client_name: orderData.clientName,
                        client_phone: orderData.clientPhone,
                        device_model: orderData.deviceModel,
                        observations: orderData.observations,
                        total: orderData.total,
                        status: orderData.status
                    }])
                    .select()
                    .single();

                if (orderError) throw orderError;

                const services = orderData.services.map(service => ({
                    order_id: order.id,
                    name: service.name,
                    price: service.price,
                    is_custom: service.custom || false,
                    custom_color: service.color,
                    custom_type: service.type
                }));

                const { error: servicesError } = await supabase
                    .from('order_services')
                    .insert(services);

                if (servicesError) throw servicesError;

                showToast(`Pedido #${order.id} registrado com sucesso!`, 'success');
                return order;
            } catch (error) {
                console.error('Error saving order:', error);
                showToast('Erro ao salvar pedido', 'danger');
                throw error;
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                // Desabilita o select durante a atualização
                const selectElement = document.querySelector(`select[data-order-id="${orderId}"]`);
                if (selectElement) {
                    selectElement.disabled = true;
                }

                const { data, error } = await supabase
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('id', orderId)
                    .select()
                    .single();

                if (error) throw error;

                // Atualiza a interface com o novo status
                const statusColor = getStatusColor(newStatus);
                if (selectElement) {
                    selectElement.className = `p-2 rounded-lg text-xs font-semibold bg-${statusColor}-100 border border-${statusColor}-300 text-${statusColor}-700 focus:outline-none`;
                    selectElement.disabled = false;
                }

                showToast(`Status do Pedido #${orderId} alterado para "${newStatus}"!`, 'success');
            } catch (error) {
                console.error('Error updating order status:', error);
                showToast('Erro ao atualizar status do pedido: ' + error.message, 'danger');
                // Re-habilita o select em caso de erro
                const selectElement = document.querySelector(`select[data-order-id="${orderId}"]`);
                if (selectElement) {
                    selectElement.disabled = false;
                }
            }
        }

        // Função auxiliar para obter a cor do status
        function getStatusColor(status) {
            const statusMap = {
                'Aguardando Avaliação': 'yellow',
                'Em Reparo': 'primary-blue',
                'Concluído': 'green',
                'Cancelado': 'red'
            };
            return statusMap[status] || 'gray';
        }

        async function deleteOrder(orderId) {
            if (!window.supabase) {
                showToast('Conexão com Supabase não inicializada', 'danger');
                return;
            }
            showModal('Confirmação de Exclusão', `Tem certeza que deseja excluir o Pedido #${orderId}? Esta ação não pode ser desfeita.`, async () => {
                try {
                    // Desabilita o botão durante a exclusão
                    const deleteButton = document.querySelector(`button[data-delete-order="${orderId}"]`);
                    if (deleteButton) {
                        deleteButton.disabled = true;
                        deleteButton.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i>`;
                        lucide.createIcons();
                    }

                    // Primeiro deleta os serviços relacionados
                    await supabase
                        .from('order_services')
                        .delete()
                        .eq('order_id', orderId);

                    // Depois deleta o pedido
                    const { error } = await supabase
                        .from('orders')
                        .delete()
                        .eq('id', orderId);

                    if (error) throw error;
                    showToast(`Pedido #${orderId} excluído com sucesso.`, 'success');
                    
                    // Recarrega os dados e atualiza a view
                    await getData();
                    navigateTo('manage-orders');
                } catch (error) {
                    console.error('Error deleting order:', error);
                    showToast('Erro ao excluir pedido: ' + error.message, 'danger');
                    
                    // Restaura o botão em caso de erro
                    const deleteButton = document.querySelector(`button[data-delete-order="${orderId}"]`);
                    if (deleteButton) {
                        deleteButton.disabled = false;
                        deleteButton.innerHTML = `<i data-lucide="trash" class="w-4 h-4"></i>`;
                        lucide.createIcons();
                    }
                }
            });
        }

        async function saveStockItem(item) {
            try {
                if (!supabase) {
                    throw new Error('Conexão com Supabase não inicializada');
                }

                // Verifica se os campos obrigatórios estão preenchidos
                if (!item.name || !item.quantity || !item.cost) {
                    throw new Error('Todos os campos obrigatórios devem ser preenchidos');
                }

                // Primeiro, verifica se já existe um item com o mesmo nome
                const { data: existingItems } = await supabase
                    .from('stock')
                    .select('*')
                    .eq('name', item.name);

                if (existingItems && existingItems.length > 0) {
                    throw new Error('Já existe um item com este nome no estoque');
                }

                // Se não existe, insere o novo item
                const { data, error } = await supabase
                    .from('stock')
                    .insert([{
                        name: item.name,
                        quantity: item.quantity,
                        cost: item.cost,
                        compatible_model: item.compatibleModel
                    }])
                    .select()
                    .single();

                if (error) {
                    throw new Error(`Erro ao salvar: ${error.message}`);
                }

                if (!data) {
                    throw new Error('Erro ao salvar: dados não retornados');
                }

                showToast(`Item "${item.name}" adicionado ao estoque.`, 'success');
                return data;
            } catch (error) {
                console.error('Erro ao salvar item:', error);
                showToast(`Erro ao salvar item: ${error.message}`, 'danger');
                throw error;
            }
        }

        async function deleteStockItem(id) {
            console.log('window.deleteStockItem chamada com itemId:', id); // DEBUG
            if (!window.supabase) {
                showToast('Conexão com Supabase não inicializada', 'danger');
                return;
            }
            showModal('Confirmação de Exclusão', 'Tem certeza que deseja excluir este item do estoque? Esta ação não pode ser desfeita.', async () => {
                try {
                    // Desabilita o botão durante a exclusão
                    const deleteButton = document.querySelector(`button[data-delete-stock="${id}"]`);
                    if (deleteButton) {
                        deleteButton.disabled = true;
                        deleteButton.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i>`;
                        lucide.createIcons();
                    }

                    if (!supabase) {
                        throw new Error('Conexão com Supabase não inicializada');
                    }

                    if (!id) {
                        throw new Error('ID do item não fornecido');
                    }

                    const { error } = await supabase
                        .from('stock')
                        .delete()
                        .eq('id', id);

                    if (error) {
                        throw error;
                    }

                    showToast('Item removido do estoque com sucesso.', 'success');
                    await updateStockList();
                } catch (error) {
                    console.error('Erro ao deletar item:', error);
                    showToast('Erro ao remover item: ' + error.message, 'danger');

                    // Restaura o botão em caso de erro
                    const deleteButton = document.querySelector(`button[data-delete-stock="${id}"]`);
                    if (deleteButton) {
                        deleteButton.disabled = false;
                        deleteButton.innerHTML = `<i data-lucide="trash" class="w-4 h-4"></i>`;
                        lucide.createIcons();
                    }
                }
            });
        }

        async function generateRevenueLog() {
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select('created_at, total')
                    .eq('status', 'Concluído')
                    .gte('created_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());

                if (error) throw error;

                const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                const revenueByDay = {};

                // Inicializa todos os dias com 0
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    revenueByDay[days[date.getDay()]] = 0;
                }

                // Soma as receitas por dia
                data.forEach(order => {
                    const date = new Date(order.created_at);
                    const day = days[date.getDay()];
                    revenueByDay[day] += Number(order.total);
                });

                return Object.entries(revenueByDay).map(([day, revenue]) => ({
                    day,
                    revenue
                }));
            } catch (error) {
                console.error('Error generating revenue log:', error);
                return [];
            }
        }

    async function saveModel(model) {
        try {
            const { data, error } = await supabase
                .from('models')
                .insert([{
                    brand: model.brand,
                    name: model.name
                }])
                .select();

            if (error) throw error;
            showToast(`Modelo ${model.brand} - ${model.name} adicionado com sucesso!`, 'success');
            return data[0];
        } catch (error) {
            console.error('Error saving model:', error);
            showToast('Erro ao salvar modelo', 'danger');
            return null;
        }
    }        async function saveService(service) {
            try {
                const { error } = await supabase
                    .from('services')
                    .insert([{
                        name: service.name,
                        price: service.price
                    }]);

                if (error) throw error;
                showToast(`Serviço "${service.name}" adicionado com sucesso!`, 'success');
                return true;
            } catch (error) {
                console.error('Error saving service:', error);
                showToast('Erro ao salvar serviço', 'danger');
                return false;
            }
        }

        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Cores Tailwind baseadas nas variáveis CSS para utilidade
                        'primary-blue': 'var(--color-primary)', 
                        'secondary-blue': 'var(--color-secondary)',
                        'bg-light': 'var(--color-bg-light)', 
                        'dark-gray': 'var(--color-dark-gray)', 
                        'text-dark': 'var(--color-text-dark)', 
                    }
                }
            }
        }
    </script>
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js para Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Variáveis CSS para Cores Centrais e Fluidez --- */
        :root {
            --color-primary: #3b82f6; /* Azul Principal */
            --color-secondary: #93c5fd; /* Azul Claro/Destaque */
            --color-bg-light: #f8fafc; /* Fundo Off-White */
            --color-text-dark: #1e293b; /* Texto Principal */
            --color-dark-gray: #1e293b; /* Fundo da Ilha */
        }
        
        /* Estilos Customizados para o Tema Profissional */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-bg-light); 
            transition: background-color 0.3s ease; /* Transição para temas */
        }
        
        /* Polimento e Fluidez nos Cards */
        .card { 
            background-color: white; 
            border-radius: 12px; 
            /* Sombra mais suave e profunda */
            box-shadow: 0 6px 15px -3px rgba(0, 0, 0, 0.15), 0 2px 4px -2px rgba(0, 0, 0, 0.08); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Transição suave e uniforme */
        }
        .card:hover { 
            transform: translateY(-3px); 
            /* Sombra mais intensa no hover para sensação de flutuação */
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2); 
        }
        
        /* Polimento e Fluidez nos Inputs */
        .input-field { 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            padding: 10px; 
            transition: border-color 0.3s, box-shadow 0.3s; 
        }
        .input-field:focus { 
            border-color: var(--color-primary); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); /* Efeito de foco mais suave */
        }
        
        /* Polimento e Fluidez nos Botões */
        .btn-primary { 
            background-color: var(--color-primary); 
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; 
        }
        .btn-primary:hover { 
            background-color: #2563eb; 
            transform: translateY(-1px); 
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }
        .btn-primary:active { transform: translateY(0); }
        
        /* Transição Aprimorada de Conteúdo */
        #main-content-wrapper { 
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; 
        }

        /* Container para Simular a Transição de Páginas (Efeito "Arrastar") */
        /* (Removido o transition inline, agora está no #main-content-wrapper) */

        /* Estilo da Capinha Personalizada */
        .phone-frame { width: 150px; height: 300px; border: 8px solid var(--color-text-dark); border-radius: 20px; padding: 5px; background-color: #000; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5); position: relative; }
        .phone-case { width: 100%; height: 100%; border-radius: 12px; transition: background-color 0.3s ease; }

        /* --- Lógica de Estilo da Sidebar (Mobile First) --- */

        #sidebar {
            /* Mobile Padrão: Menu Slide-in */
            width: 16rem; /* 256px */
            height: 100vh;
            background-color: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            transform: translateX(-100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            left: 0;
            top: 0;
            z-index: 50;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        /* Estilo do item ativo no menu mobile */
        @media (max-width: 767px) {
            .nav-link.active {
                background-color: var(--color-primary);
                color: white !important;
            }
            .nav-link {
                transition: all 0.3s ease;
                border-radius: 0.75rem;
                padding: 0.75rem 1rem;
            }
            .nav-link:hover {
                background-color: var(--color-primary);
                color: white;
            }
        }

        #sidebar.open { 
            transform: translateX(0);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        }

        /* Desktop: Estilo Ilha/Dock GLASSMORPHISM */
        @media (min-width: 768px) {
            #sidebar {
                /* Dock/Island Style */
                width: 4rem; /* 64px, compacto */
                height: auto;
                top: 50%; 
                left: 1rem; 
                transform: translateY(-50%); 
                border-radius: 1.5rem; 
                padding: 0.5rem 0;
                
                /* Efeito GLASSMORPHISM */
                background-color: rgba(255, 255, 255, 0.15); /* Um pouco mais de opacidade */
                backdrop-filter: blur(12px); 
                -webkit-backdrop-filter: blur(12px); 
                
                /* Sombra flutuante */
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.2); 
                
                display: flex !important; 
            }
            /* Esconde textos e informações de usuário no Dock */
            .mobile-only-text { display: none !important; }

            .dock-link {
                /* Links do Dock: Icones centralizados e fluídos */
                justify-content: center;
                position: relative;
                /* Use texto escuro semi-transparente para melhorar contraste em fundo claro */
                color: rgba(30, 41, 59, 0.85); /* var(--color-text-dark) com leve transparência */
                transition: all 0.22s ease-in-out; /* Transição para hover/ativo */
                padding: 0.6rem; /* um pouco mais de área clicável */
                display: flex;
                align-items: center;
            }

            /* Estado dos itens não ativos: levemente desaturados, porém legíveis */
            .dock-link:not(.active) {
                color: rgba(30, 41, 59, 0.65);
                background-color: transparent;
                opacity: 0.95;
            }

            .dock-link:hover {
                background-color: rgba(255, 255, 255, 0.32); /* Hover mais nítido */
                transform: translateY(-2px) scale(1.03); /* efeito sutil */
                color: rgba(30, 41, 59, 0.95);
            }

            .dock-link.active {
                /* Active: Brilho + Inset Shadow para Profundidade */
                color: var(--color-primary); /* Usa variável */
                background-color: rgba(255, 255, 255, 0.45); /* Fundo mais visível para destaque */
                box-shadow: 0 6px 18px rgba(59, 130, 246, 0.18), inset 0 1px 0 rgba(255,255,255,0.6);
            }
            /* --- Dock Glider (inspirado no glass-glider) --- */
            .dock-glider {
                position: absolute;
                left: 0.25rem; /* alinhado com o padding do dock */
                right: 0.25rem;
                width: calc(100% - 0.5rem);
                height: 3.2rem; /* altura aproximada de cada item */
                border-radius: 1rem;
                z-index: 0;
                background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
                box-shadow:
                    inset 1px 1px 6px rgba(255,255,255,0.06),
                    inset -1px -1px 8px rgba(0,0,0,0.25),
                    0 8px 20px rgba(0,0,0,0.12);
                transform: translateY(0%);
                transition: transform 0.5s cubic-bezier(0.37, 1.95, 0.66, 0.56), background 0.35s ease-in-out, box-shadow 0.35s ease-in-out;
                pointer-events: none;
            }

            /* Variant colors when moved via JS (we'll toggle data-color) */
            .dock-glider[data-color="primary"] {
                background: linear-gradient(180deg, rgba(59,130,246,0.12), rgba(59,130,246,0.06));
                box-shadow: 0 8px 20px rgba(59,130,246,0.12), inset 0 0 6px rgba(255,255,255,0.25);
            }
            .dock-glider[data-color="muted"] {
                background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
                box-shadow: 0 6px 16px rgba(0,0,0,0.08), inset 0 0 6px rgba(255,255,255,0.06);
            }
        }
    </style>
</head>
<body class="flex h-screen bg-bg-light">

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3">
        <!-- Notificações aparecerão aqui -->
    </div>

    <!-- Sidebar (Ilha/Dock em Desktop, Slide-in em Mobile) -->
    <aside id="sidebar" class="flex flex-col p-4">
        
        <!-- Logo e Título (Visível apenas em Mobile) -->
        <div class="text-2xl font-bold text-text-dark mb-8 mt-2 flex items-center mobile-only-text">
            <span class="text-primary-blue mr-2">O</span>N<span class="text-primary-blue">E</span>TECH
        </div>
        
        <nav class="flex-grow space-y-2">
            <!-- Os links foram ajustados para serem ícone-only no desktop (dock-link) -->
            <!-- Dock glider: highlight that slides to the active item (animated) -->
            <div class="dock-glider" aria-hidden="true"></div>
            
            <!-- Nav Item: Dashboard -->
            <a href="#" data-view="dashboard" class="nav-link dock-link flex items-center p-3 rounded-xl text-text-dark active">
                <i data-lucide="layout-dashboard" class="w-5 h-5 md:mr-0 mr-3"></i>
                <span class="md:hidden mobile-only-text">Dashboard</span>
            </a>
            <!-- Nav Item: Novo Pedido de Serviço -->
            <a href="#" data-view="new-order" class="nav-link dock-link flex items-center p-3 rounded-xl text-text-dark">
                <i data-lucide="file-plus" class="w-5 h-5 md:mr-0 mr-3"></i>
                <span class="md:hidden mobile-only-text">Novo Pedido</span>
            </a>
            <!-- Nav Item: Gerenciamento de Pedidos -->
            <a href="#" data-view="manage-orders" class="nav-link dock-link flex items-center p-3 rounded-xl text-text-dark">
                <i data-lucide="clipboard-list" class="w-5 h-5 md:mr-0 mr-3"></i>
                <span class="md:hidden mobile-only-text">Gerenciar Pedidos</span>
            </a>
            <!-- Nav Item: Controle de Estoque -->
            <a href="#" data-view="stock" class="nav-link dock-link flex items-center p-3 rounded-xl text-text-dark">
                <i data-lucide="package" class="w-5 h-5 md:mr-0 mr-3"></i>
                <span class="md:hidden mobile-only-text">Estoque</span>
            </a>
            <!-- Nav Item: Capinhas Personalizadas -->
            <a href="#" data-view="custom-cases" class="nav-link dock-link flex items-center p-3 rounded-xl text-text-dark">
                <i data-lucide="smartphone" class="w-5 h-5 md:mr-0 mr-3"></i>
                <span class="md:hidden mobile-only-text">Capinhas Custom</span>
            </a>
            <!-- Nav Item: Administração do Sistema -->
            <a href="#" data-view="admin" class="nav-link dock-link flex items-center p-3 rounded-xl text-text-dark">
                <i data-lucide="settings" class="w-5 h-5 md:mr-0 mr-3"></i>
                <span class="md:hidden mobile-only-text">Administração</span>
            </a>
        </nav>

        <!-- Informação do Usuário (Visível apenas em Mobile) -->
        <div class="mt-4 pt-4 border-t border-gray-100 mobile-only-text">
            <p class="text-xs text-gray-400">Usuário ID: <span id="user-id-display" class="text-dark-gray font-medium"></span></p>
        </div>
    </aside>

    <!-- Overlay de Fundo (Apenas Mobile) -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden md:hidden" onclick="toggleSidebar()"></div>

    <!-- Área de Conteúdo Principal -->
    <!-- ml-0 em mobile, md:pl-24 em desktop para deixar espaço para o dock flutuante -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8 ml-0 md:pl-24 relative">
        <!-- Barra de Título e Botão de Menu (Apenas Mobile) -->
        <header class="flex justify-between items-center mb-6 md:hidden">
            <div class="flex items-center gap-2">
                <img src="image/logo-onetech.png" alt="Logo ONETECH" class="h-8 w-8 object-contain rounded-md shadow-sm" />
                <h1 class="text-xl font-bold text-text-dark">ONETECH Pro</h1>
            </div>
            <button onclick="toggleSidebar()" class="p-2 rounded-full bg-white shadow-md text-text-dark">
                <i id="menu-icon" data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </header>

        <div id="main-content-wrapper" class="w-full h-full">
            <!-- As views serão renderizadas e substituídas aqui -->
        </div>
    </main>

<script>
    // Variáveis Globais do Canvas
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // Simulação de Dados (localStorage/sessionStorage)
    const LS_KEY = 'onetech_pro_data';
    const SS_KEY = 'onetech_pro_custom_case';

    /**
     * Inicializa os dados no localStorage com valores padrão se não existirem.
     */
    function initializeData() {
        const defaultData = {
            orders: [],
            stock: [],
            models: [
                { brand: 'Apple', name: 'iPhone 15 Pro Max' },
                { brand: 'Samsung', name: 'Galaxy S23 Ultra' },
                { brand: 'Xiaomi', name: 'Redmi Note 12' },
            ],
            services: [
                { name: 'Troca de Tela', price: 350.00 },
                { name: 'Troca de Bateria', price: 120.00 },
                { name: 'Desoxidação', price: 80.00 },
            ],
            appData: {
                lastOrderId: 1000,
                revenueLog: generateMockRevenueLog(),
            }
        };

        if (!localStorage.getItem(LS_KEY)) {
            localStorage.setItem(LS_KEY, JSON.stringify(defaultData));
        }
    }

    /* --- Dock Glider: position and behavior --- */
    function moveDockGlider() {
        try {
            const glider = document.querySelector('.dock-glider');
            const dock = document.getElementById('sidebar');
            if (!glider || !dock) return;

            // Find active link (desktop)
            const links = dock.querySelectorAll('.dock-link');
            let activeIndex = -1;
            links.forEach((l, i) => { if (l.classList.contains('active')) activeIndex = i; });

            // If no active, collapse to top (or keep first visible)
            const targetIndex = activeIndex >= 0 ? activeIndex : 0;

            // Compute vertical translation based on link position
            const firstLink = links[0];
            if (!firstLink) return;

            const linkHeight = firstLink.getBoundingClientRect().height + parseFloat(getComputedStyle(firstLink).marginTop || 0) + parseFloat(getComputedStyle(firstLink).marginBottom || 0);
            const offset = targetIndex * linkHeight;

            // Set transform
            glider.style.transform = `translateY(${offset}px)`;

            // Toggle color accent when active is the dashboard (example)
            const activeLink = links[targetIndex];
            if (activeLink && activeLink.classList.contains('active')) {
                glider.setAttribute('data-color', 'primary');
            } else {
                glider.setAttribute('data-color', 'muted');
            }
        } catch (e) {
            // fail silently
            console.error('moveDockGlider error', e);
        }
    }

    // Reposition on load and resize
    window.addEventListener('load', () => setTimeout(moveDockGlider, 50));
    window.addEventListener('resize', () => setTimeout(moveDockGlider, 50));

    /**
     * Gera um log de receita mock para o gráfico.
     */
    function generateMockRevenueLog() {
        const log = [];
        const days = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
        for (let i = 0; i < 7; i++) {
            log.push({
                day: days[i],
                revenue: parseFloat((Math.random() * 2000 + 500).toFixed(2))
            });
        }
        return log;
    }

    /**
     * Retorna todos os dados do Supabase.
     * @returns {Promise<object>} Dados da aplicação.
     */
    async function getData() {
        try {
            const [
                { data: orders, error: ordersError }, 
                { data: stock, error: stockError },
                { data: models, error: modelsError },
                { data: services, error: servicesError }
            ] = await Promise.all([
                supabase.from('orders').select('*, order_services(*)').order('created_at', { ascending: false }),
                supabase.from('stock').select('*'),
                supabase.from('models').select('*'),
                supabase.from('services').select('*')
            ]);

            // Verifica erros
            if (ordersError) throw ordersError;
            if (stockError) throw stockError;
            if (modelsError) throw modelsError;
            if (servicesError) throw servicesError;

            return {
                orders: orders || [],
                stock: stock || [],
                models: models || [],
                services: services || [],
                appData: {
                    revenueLog: await generateRevenueLog()
                }
            };
        } catch (error) {
            console.error('Error fetching data:', error);
            showToast('Erro ao carregar dados: ' + error.message, 'danger');
            throw error;
        }
    }

    /**
     * Salva dados no Supabase.
     * @param {string} table - Nome da tabela.
     * @param {object} data - Dados a serem salvos.
     */
    async function saveData(table, data) {
        try {
            const { error } = await supabase.from(table).insert([data]);
            if (error) throw error;
            showToast('Dados salvos com sucesso!', 'success');
            renderView(activeView);
        } catch (error) {
            console.error('Error saving data:', error);
            showToast('Erro ao salvar dados: ' + error.message, 'danger');
            throw error;
        }
    }

    /**
     * Retorna o item temporário da Capinha Personalizada.
     */
    function getCustomCase() {
        const data = sessionStorage.getItem(SS_KEY);
        return data ? JSON.parse(data) : null;
    }

    /**
     * Define o item temporário da Capinha Personalizada.
     * @param {object|null} item - Item a ser salvo ou null para remover.
     */
    function setCustomCase(item) {
        if (item) {
            sessionStorage.setItem(SS_KEY, JSON.stringify(item));
            showToast('Capinha adicionada temporariamente ao pedido!', 'success');
        } else {
            sessionStorage.removeItem(SS_KEY);
        }
    }

    // --- Lógica de UI e Navegação ---
    let activeView = 'dashboard';
    let contentWrapper;
    let sidebar;
    let sidebarOverlay;
    let menuIcon;
    let userIdDisplay;
    
    // Função para inicializar os elementos DOM
    function initializeDOMElements() {
        contentWrapper = document.getElementById('main-content-wrapper');
        sidebar = document.getElementById('sidebar');
        sidebarOverlay = document.getElementById('sidebar-overlay');
        menuIcon = document.getElementById('menu-icon');
        userIdDisplay = document.getElementById('user-id-display');
        
        if (!contentWrapper) console.error('main-content-wrapper não encontrado');
        if (!sidebar) console.error('sidebar não encontrado');
        if (!sidebarOverlay) console.error('sidebar-overlay não encontrado');
        if (!menuIcon) console.error('menu-icon não encontrado');
        if (!userIdDisplay) console.error('user-id-display não encontrado');
        
        // Set user ID display if element exists
        if (userIdDisplay) {
            const dummyUserId = crypto.randomUUID().substring(0, 8); // Simula o ID do usuário
            userIdDisplay.textContent = dummyUserId;
        }

        // Bind click behavior for nav links to use our navigateTo and update glider
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            // prevent default and navigate
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const view = link.getAttribute('data-view');
                if (view) navigateTo(view);
                // move glider immediately for snappier feedback
                setTimeout(moveDockGlider, 10);
            });

            // keyboard accessibility
            link.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    link.click();
                }
            });
        });
    }

    /**
     * Alterna a visibilidade da Sidebar (apenas em mobile).
     */
    window.toggleSidebar = function() {
        const isMobile = window.innerWidth < 768;
        if (!isMobile) return; // Só funciona em mobile

        const isOpen = sidebar.classList.contains('open');
        
        // Toggle da classe open
        if (isOpen) {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.add('hidden');
            menuIcon.setAttribute('data-lucide', 'menu');
        } else {
            sidebar.classList.add('open');
            sidebarOverlay.classList.remove('hidden');
            menuIcon.setAttribute('data-lucide', 'x');
        }
        
        // Atualiza os ícones
        lucide.createIcons();
        
        // Previne scroll do body quando o menu está aberto
        document.body.style.overflow = isOpen ? '' : 'hidden';
    }

    /**
     * Exibe uma notificação Toast.
     * @param {string} message - Mensagem a ser exibida.
     * @param {string} type - Tipo (success, danger, warning).
     */
    function showToast(message, type = 'success') {
        // Cores hardcoded aqui pois o Toast precisa de cores sólidas, não variáveis CSS
        const colors = {
            success: 'bg-green-100 border-green-400 text-green-700',
            danger: 'bg-red-100 border-red-400 text-red-700',
            warning: 'bg-yellow-100 border-yellow-400 text-yellow-700',
            info: 'bg-primary-blue/10 border-primary-blue text-primary-blue',
        };

        const icons = {
            success: 'check-circle',
            danger: 'alert-triangle',
            warning: 'alert-triangle',
            info: 'info',
        }

        const toast = document.createElement('div');
        toast.className = `p-4 rounded-xl border-l-4 shadow-md ${colors[type]} flex items-center transition-all duration-300 transform translate-x-full opacity-0`;
        toast.innerHTML = `
            <i data-lucide="${icons[type]}" class="w-5 h-5 mr-3 flex-shrink-0"></i>
            <span class="font-medium text-sm">${message}</span>
        `;

        const container = document.getElementById('toast-container');
        container.appendChild(toast);

        // Força o reflow para garantir a transição
        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
            toast.style.opacity = '1';
        }, 10);

        // Remove a notificação após 4 segundos
        setTimeout(() => {
            toast.style.transform = 'translateX(100%)';
            toast.style.opacity = '0';
            toast.addEventListener('transitionend', () => toast.remove());
        }, 4000);

        // Renderiza os ícones Lucide
        lucide.createIcons();
    }

    /**
     * Altera a view ativa e renderiza o conteúdo.
     * @param {string} viewName - Nome da view.
     */
    function navigateTo(viewName) {
        if (activeView === viewName) {
            if (window.innerWidth < 768) toggleSidebar(); 
            return;
        }

        // Fecha a sidebar em mobile ao navegar
        if (window.innerWidth < 768 && sidebar.classList.contains('open')) {
            toggleSidebar();
        }

        // Atualiza a navegação ativa (aplica apenas classes — não força estilos inline)
        document.querySelectorAll('.nav-link').forEach(link => {
            const isActive = link.getAttribute('data-view') === viewName;
            link.classList.toggle('active', isActive);
            link.classList.toggle('text-text-dark', !isActive);
            if (isActive) {
                link.classList.add('bg-primary-blue', 'bg-opacity-10', 'text-primary-blue');
            } else {
                link.classList.remove('bg-primary-blue', 'bg-opacity-10', 'text-primary-blue');
            }
        });

        // Efeito "Arrastar" (Slide + Fade) - Mais fluido
        if (contentWrapper) {
            contentWrapper.style.transform = 'translateY(10px)'; // Movimento vertical sutil
            contentWrapper.style.opacity = '0';

            // Atualiza o estado e a classe da navegação
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            
                // Lógica de Dock (Desktop)
                if (window.innerWidth >= 768) {
                    // Remove estilos ativos e reset; do NOT set inline color so CSS controls visibility
                    link.classList.remove('bg-white/30'); 
                    link.style.boxShadow = 'none'; 
                    link.style.removeProperty('color');
                }
                
                if (link.getAttribute('data-view') === viewName) {
                    link.classList.add('active');
                    
                    // Aplica estilos ativos do Dock Moderno (prefira classes/CSS em vez de inline)
                    if (window.innerWidth >= 768) {
                        link.classList.add('bg-white/30');
                        // Use boxShadow inline for stronger effect but keep color to CSS
                        link.style.boxShadow = '0 0 15px rgba(59, 130, 246, 0.8), inset 0 0 5px rgba(255, 255, 255, 0.6)'; 
                    }
                }
            });

            // Move the dock glider to the active item (if present)
            setTimeout(() => moveDockGlider(), 10);

            setTimeout(() => {
                activeView = viewName;
                renderView(viewName);
                
                // Retorna o efeito de slide/fade
                contentWrapper.style.transform = 'translateY(0)';
                contentWrapper.style.opacity = '1';
            }, 300); // Tempo da transição CSS
        }
    }

    /**
     * Renderiza o conteúdo da view principal.
     * @param {string} viewName - Nome da view a ser renderizada.
     */
    async function renderView(viewName) {
        try {
            // Mostra loading enquanto carrega os dados
            if (contentWrapper) {
                contentWrapper.innerHTML = `
                    <div class="flex items-center justify-center h-64">
                        <i data-lucide="loader" class="w-8 h-8 animate-spin text-primary-blue"></i>
                    </div>
                `;
                lucide.createIcons();
            }

            // Busca os dados do Supabase
            if (!contentWrapper) {
                throw new Error('Elemento contentWrapper não encontrado');
            }

            const [
                { data: orders, error: ordersError }, 
                { data: stock, error: stockError },
                { data: models, error: modelsError },
                { data: services, error: servicesError }
            ] = await Promise.all([
                supabase.from('orders').select('*, order_services(*)').order('created_at', { ascending: false }),
                supabase.from('stock').select('*'),
                supabase.from('models').select('*'),
                supabase.from('services').select('*')
            ]);

            // Verifica erros
            if (ordersError) throw ordersError;
            if (stockError) throw stockError;
            if (modelsError) throw modelsError;
            if (servicesError) throw servicesError;

            let htmlContent = '';
            switch (viewName) {
                case 'dashboard':
                    htmlContent = renderDashboard(orders || [], stock || [], models || []);
                    break;
                case 'new-order':
                    htmlContent = renderNewOrderForm(models || [], services || [], stock || []);
                    break;
                case 'manage-orders':
                    htmlContent = await renderManageOrders();
                    break;
                case 'stock':
                    htmlContent = renderStockControl(stock || []);
                    break;
                case 'custom-cases':
                    htmlContent = renderCustomCases();
                    break;
                case 'admin':
                    htmlContent = renderAdmin(models || [], services || []);
                    break;
                default:
                    htmlContent = `<div class="p-8 text-center text-gray-500">View não encontrada.</div>`;
            }

            if (contentWrapper) {
                contentWrapper.innerHTML = htmlContent;
                lucide.createIcons();
                
                // Inicializa lógicas específicas da view
                if (viewName === 'dashboard') {
                    await initializeDashboardChart(await generateRevenueLog());
                } else if (viewName === 'new-order') {
                    initializeNewOrderLogic(models, services, stock);
                } else if (viewName === 'manage-orders') {
                    initializeManageOrdersLogic(orders);
                } else if (viewName === 'stock') {
                    initializeStockLogic();
                } else if (viewName === 'custom-cases') {
                    initializeCustomCasesLogic();
                } else if (viewName === 'admin') {
                    initializeAdminLogic();
                }
            }
        } catch (error) {
            console.error('Error loading data:', error);
            if (contentWrapper) {
                contentWrapper.innerHTML = `
                    <div class="p-8 text-center text-red-500">
                        <i data-lucide="alert-triangle" class="w-16 h-16 mx-auto mb-4"></i>
                        <p class="text-lg font-semibold">Erro ao carregar dados</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </div>
                `;
                lucide.createIcons();
            }
            showToast('Erro ao carregar dados: ' + error.message, 'danger');
            return;
        }
        // Initialization has already been handled in the try block
    }

    // --- Implementação das Views (Mantidas do código anterior) ---

    /**
     * View A: Dashboard
     */
    function renderDashboard(orders = [], stock = [], models = [], revenueLog = []) {
        // Calcula pedidos do mês atual
        const currentMonth = new Date().getMonth();
        const ordersMonth = orders.filter(o => {
            const date = new Date(o.created_at || o.date);
            return date.getMonth() === currentMonth && o.status === 'Concluído';
        }).length;
        
        // Calcula receita do mês atual
        const revenueMonth = orders
            .filter(o => {
                const date = new Date(o.created_at || o.date);
                return date.getMonth() === currentMonth && o.status === 'Concluído';
            })
            .reduce((sum, o) => sum + (o.total || 0), 0)
            .toFixed(2);

        // Calcula totais de estoque e modelos
        const stockCount = stock.reduce((sum, item) => sum + (item.quantity || 0), 0);
        const modelsCount = models.length;

        return `
            <h1 class="text-3xl font-bold text-text-dark mb-8">Dashboard de Performance</h1>

            <!-- Ajustado para 2 colunas em telas pequenas e 4 em telas grandes -->
            <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                ${renderDashboardCard('Pedidos (Mês)', ordersMonth, 'clipboard-check', 'primary-blue')}
                ${renderDashboardCard('Receita (Mês)', `R$ ${revenueMonth.replace('.', ',')}`, 'trending-up', 'green-600')}
                ${renderDashboardCard('Estoque Total', stockCount, 'package', 'yellow-600')}
                ${renderDashboardCard('Modelos Cadastrados', modelsCount, 'smartphone', 'red-600')}
            </div>

            <div class="card p-6 h-96">
                <h2 class="text-xl font-semibold text-text-dark mb-4">Performance Semanal (Receita)</h2>
                <canvas id="revenueChart"></canvas>
            </div>
        `;
    }

    function renderDashboardCard(title, value, icon, color) {
        return `
            <div class="card p-4 md:p-5 flex flex-col justify-between">
                <div>
                    <i data-lucide="${icon}" class="w-6 h-6 md:w-8 md:h-8 text-${color} mb-2 md:mb-3 p-1.5 bg-${color}/10 rounded-full"></i>
                    <p class="text-xs md:text-sm font-medium text-gray-500">${title}</p>
                </div>
                <p class="text-xl md:text-3xl font-bold text-text-dark mt-1 md:mt-2">${value}</p>
            </div>
        `;
    }

    let chartInstance = null;
    function initializeDashboardChart(revenueLog) {
        if (chartInstance) {
            chartInstance.destroy();
        }
        
        const ctx = document.getElementById('revenueChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: revenueLog.map(log => log.day),
                datasets: [{
                    label: 'Receita (R$)',
                    data: revenueLog.map(log => log.revenue),
                    backgroundColor: 'var(--color-primary)', 
                    borderColor: '#2563eb',
                    borderWidth: 1,
                    borderRadius: 6,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { drawOnChartArea: false },
                        ticks: { callback: function(value) { return `R$ ${value.toFixed(0)}`; } }
                    },
                    x: {
                        grid: { drawOnChartArea: false }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Receita: R$ ${context.parsed.y.toFixed(2).replace('.', ',')}`;
                            }
                        }
                    }
                }
            }
        });
    }

    /**
     * View B: Novo Pedido de Serviço
     */
    function renderNewOrderForm(models, services, stock) {
        const customCase = getCustomCase();
        
        const modelOptions = models.map(m => 
            `<option value="${m.brand} - ${m.name}">${m.brand} - ${m.name}</option>`
        ).join('');
        
        const serviceCheckboxes = services.map((s, index) => `
            <div class="flex items-center justify-between p-3 bg-bg-light rounded-lg">
                <label for="service-${index}" class="text-text-dark font-medium flex items-center cursor-pointer">
                    <input type="checkbox" id="service-${index}" data-price="${s.price}" data-name="${s.name}" class="service-checkbox w-4 h-4 text-primary-blue bg-gray-100 border-gray-300 rounded focus:ring-primary-blue">
                    <span class="ml-2">${s.name}</span>
                </label>
                <span class="text-sm font-semibold text-primary-blue">R$ ${s.price.toFixed(2).replace('.', ',')}</span>
            </div>
        `).join('');
        
        const stockProductsCheckboxes = `
            <div class="flex items-center justify-between p-3 bg-bg-light rounded-lg mb-3">
                <label for="product-none" class="text-text-dark font-medium flex items-center cursor-pointer">
                    <input type="checkbox" id="product-none" data-price="0" data-name="Nenhum produto (cliente já possui)" data-id="none"
                           class="product-checkbox w-4 h-4 text-primary-blue bg-gray-100 border-gray-300 rounded focus:ring-primary-blue" checked>
                    <span class="ml-2">Nenhum produto (cliente já possui)</span>
                </label>
                <div class="flex flex-col items-end">
                    <span class="text-sm font-semibold text-primary-blue">R$ 0,00</span>
                </div>
            </div>
        ` + (stock && stock.length > 0 ? stock.map((item, index) => {
            const isAvailable = item.quantity > 0;
            const availabilityClass = isAvailable ? 'bg-bg-light' : 'bg-red-100';
            const availabilityText = isAvailable ? `Disponível (${item.quantity})` : 'Indisponível';
            const availabilityTextClass = isAvailable ? 'text-green-600' : 'text-red-600';
            
            return `
                <div class="flex items-center justify-between p-3 ${availabilityClass} rounded-lg">
                    <label for="product-${index}" class="text-text-dark font-medium flex items-center cursor-pointer ${!isAvailable ? 'opacity-50' : ''}">
                        <input type="checkbox" id="product-${index}" data-price="${item.cost * 1.5}" data-name="${item.name}" data-id="${item.id}" data-quantity="${item.quantity}"
                               class="product-checkbox w-4 h-4 text-primary-blue bg-gray-100 border-gray-300 rounded focus:ring-primary-blue"
                               ${!isAvailable ? 'disabled' : ''}>
                        <span class="ml-2">${item.name} ${item.compatibleModel ? `(${item.compatibleModel})` : ''}</span>
                    </label>
                    <div class="flex flex-col items-end">
                        <span class="text-sm font-semibold text-primary-blue">R$ ${(item.cost * 1.5).toFixed(2).replace('.', ',')}</span>
                        <span class="text-xs ${availabilityTextClass}">${availabilityText}</span>
                    </div>
                </div>
            `;
        }).join('') : '<p class="text-gray-500 text-center py-3">Nenhum produto disponível no estoque.</p>');

        const customCaseDisplay = customCase ? `
            <div id="custom-case-display" class="p-3 bg-secondary-blue/20 rounded-lg flex justify-between items-center mb-4">
                <span class="font-medium text-text-dark flex items-center">
                    <i data-lucide="paint-roller" class="w-5 h-5 mr-2 text-primary-blue"></i>
                    Capinha Personalizada (${customCase.type})
                </span>
                <button type="button" onclick="removeCustomCase()" class="text-sm text-red-600 hover:text-red-800">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        ` : '';

        return `
            <!-- Flex quebra para coluna em telas pequenas (lg:flex-row) -->
            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Coluna Principal do Formulário (lg:w-2/3) -->
                <div class="flex-1 lg:w-2/3">
                    <h1 class="text-3xl font-bold text-text-dark mb-8">Registrar Novo Pedido de Serviço</h1>
                    <form id="new-order-form" class="space-y-6">
                        <div class="card p-6 space-y-4">
                            <h2 class="text-xl font-semibold mb-4 text-text-dark">Dados do Cliente e Dispositivo</h2>
                            <div>
                                <label for="client-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cliente</label>
                                <input type="text" id="client-name" required class="input-field w-full">
                            </div>
                            <div>
                                <label for="client-phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                                <input type="tel" id="client-phone" required class="input-field w-full">
                            </div>
                            <div>
                                <label for="device-model" class="block text-sm font-medium text-gray-700 mb-1">Marca / Modelo</label>
                                <select id="device-model" required class="input-field w-full">
                                    <option value="" disabled selected>Selecione um Modelo</option>
                                    ${modelOptions}
                                </select>
                            </div>
                            <div>
                                <label for="observations" class="block text-sm font-medium text-gray-700 mb-1">Observações / Defeitos Reportados</label>
                                <textarea id="observations" rows="3" required class="input-field w-full"></textarea>
                            </div>
                        </div>

                        <div class="card p-6">
                            <h2 class="text-xl font-semibold mb-4 text-text-dark">Serviços e Orçamento</h2>
                            <div class="space-y-2">
                                ${serviceCheckboxes}
                            </div>
                        </div>

                        <div class="card p-6">
                            <h2 class="text-xl font-semibold mb-4 text-text-dark">Produtos do Estoque</h2>
                            <div class="space-y-2" id="stock-products-container">
                                ${stockProductsCheckboxes}
                            </div>
                        </div>

                        <button type="submit" class="btn-primary w-full p-3 rounded-xl text-white font-semibold">
                            <i data-lucide="save" class="w-5 h-5 inline-block mr-2"></i>
                            Concluir Pedido (Gerar OS)
                        </button>
                    </form>
                </div>

                <!-- Coluna Lateral de Resumo (sticky apenas em desktop - lg:sticky) -->
                <div class="lg:w-1/3">
                    <div class="card p-6 lg:sticky lg:top-8">
                        <h2 class="text-xl font-semibold text-text-dark mb-4 border-b pb-2">Resumo do Pedido</h2>
                        
                        <!-- Display da Capinha Personalizada -->
                        ${customCaseDisplay}

                        <ul id="service-summary" class="space-y-2 text-sm text-gray-700 mb-4">
                            <!-- Serviços selecionados aparecerão aqui -->
                            <li class="py-1 text-gray-500">Nenhum serviço selecionado.</li>
                        </ul>

                        <div class="border-t pt-4 mt-4">
                            <div class="flex justify-between font-bold text-lg text-text-dark">
                                <span>TOTAL ESTIMADO:</span>
                                <span id="order-total" class="text-primary-blue">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Inicializa a lógica de Novo Pedido (cálculo em tempo real e submissão).
     */
    function initializeNewOrderLogic(models, services, stock) {
        const form = document.getElementById('new-order-form');
        const serviceCheckboxes = document.querySelectorAll('.service-checkbox');
        const productCheckboxes = document.querySelectorAll('.product-checkbox');
        const summaryList = document.getElementById('service-summary');
        const totalDisplay = document.getElementById('order-total');
        const customCase = getCustomCase();
        
        // Lógica para a opção "Nenhuma" nos produtos
        const productNoneCheckbox = document.getElementById('product-none');
        if (productNoneCheckbox) {
            productNoneCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    // Se "Nenhuma" for selecionado, desmarque todos os outros produtos
                    productCheckboxes.forEach(checkbox => {
                        if (checkbox.id !== 'product-none') {
                            checkbox.checked = false;
                        }
                    });
                }
                updateSummary();
            });
            
            // Adiciona evento para os outros produtos
            productCheckboxes.forEach(checkbox => {
                if (checkbox.id !== 'product-none') {
                    checkbox.addEventListener('change', function() {
                        if (this.checked && productNoneCheckbox.checked) {
                            // Se algum produto for selecionado, desmarque a opção "Nenhuma"
                            productNoneCheckbox.checked = false;
                        }
                        updateSummary();
                    });
                }
            });
        }

        /** Calcula e atualiza o resumo e o total */
        function updateSummary() {
            let total = 0;
            let summaryHtml = '';
            const selectedServices = [];

            // 1. Serviços Padrão
            serviceCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const price = parseFloat(checkbox.getAttribute('data-price'));
                    const name = checkbox.getAttribute('data-name');
                    total += price;
                    selectedServices.push({ name, price });
                    summaryHtml += `<li class="flex justify-between"><span>${name}</span><span class="font-semibold">R$ ${price.toFixed(2).replace('.', ',')}</span></li>`;
                }
            });
            
            // 2. Produtos do Estoque
            productCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const price = parseFloat(checkbox.getAttribute('data-price'));
                    const name = checkbox.getAttribute('data-name');
                    total += price;
                    selectedServices.push({ name, price });
                    summaryHtml += `<li class="flex justify-between text-green-600"><span>${name}</span><span class="font-semibold">R$ ${price.toFixed(2).replace('.', ',')}</span></li>`;
                }
            });

            // 3. Capinha Personalizada (se existir)
            if (customCase) {
                total += customCase.price;
                selectedServices.push({ name: `Capinha Personalizada - ${customCase.color} (${customCase.type})`, price: customCase.price, custom: true });
                summaryHtml += `
                    <li class="flex justify-between text-secondary-blue font-medium">
                        <span>Capinha Personalizada (${customCase.type})</span>
                        <span>R$ ${customCase.price.toFixed(2).replace('.', ',')}</span>
                    </li>
                `;
            }

            if (summaryHtml === '') {
                summaryHtml = `<li class="py-1 text-gray-500">Nenhum item selecionado.</li>`;
            }

            summaryList.innerHTML = summaryHtml;
            totalDisplay.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        // Adiciona listeners para cálculo em tempo real
        serviceCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSummary);
        });
        
        productCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSummary);
        });

        // Atualiza o resumo inicial
        updateSummary();

        // Lógica de Submissão do Formulário
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Desabilita o botão de submit para prevenir submissões duplas
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonContent = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <i data-lucide="loader" class="w-5 h-5 animate-spin mr-2"></i>
                Salvando pedido...
            `;
            lucide.createIcons();
            
            try {
                const selectedItems = [];
                const stockUpdates = [];
                
                // Adiciona serviços selecionados
                serviceCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        selectedItems.push({ 
                            name: cb.getAttribute('data-name'), 
                            price: parseFloat(cb.getAttribute('data-price')),
                            type: 'service'
                        });
                    }
                });
                
                // Adiciona produtos selecionados
                productCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        const productId = cb.getAttribute('data-id');
                        selectedItems.push({ 
                            name: cb.getAttribute('data-name'), 
                            price: parseFloat(cb.getAttribute('data-price')),
                            type: 'product',
                            product_id: productId
                        });
                        
                        // Adiciona à lista de atualizações de estoque
                        stockUpdates.push({
                            id: productId
                        });
                    }
                });

                if (customCase) {
                    selectedItems.push({ 
                        name: `Capinha Personalizada - ${customCase.color} (${customCase.type})`, 
                        price: customCase.price,
                        custom: true,
                        type: 'custom'
                    });
                }

                if (selectedItems.length === 0) {
                    showToast('Selecione pelo menos um serviço ou produto!', 'warning');
                    return;
                }

                const newOrder = {
                    clientName: document.getElementById('client-name').value,
                    clientPhone: document.getElementById('client-phone').value,
                    deviceModel: document.getElementById('device-model').value,
                    observations: document.getElementById('observations').value,
                    services: selectedItems,
                    total: parseFloat(totalDisplay.textContent.replace('R$', '').replace(',', '.')),
                    status: 'Aguardando Avaliação',
                    date: new Date().toISOString(),
                };

                const order = await saveOrder(newOrder);
                
                if (order) {
                    // Atualiza o estoque para cada produto selecionado
                    if (stockUpdates.length > 0) {
                        for (const item of stockUpdates) {
                            try {
                                // Busca o item atual do estoque
                                const { data: stockItem, error: getError } = await supabase
                                    .from('stock')
                                    .select('*')
                                    .eq('id', item.id)
                                    .single();
                                
                                if (getError) throw getError;
                                
                                if (stockItem && stockItem.quantity > 0) {
                                    // Atualiza a quantidade no estoque (reduz em 1)
                                    const { error: updateError } = await supabase
                                        .from('stock')
                                        .update({ quantity: stockItem.quantity - 1 })
                                        .eq('id', item.id);
                                    
                                    if (updateError) throw updateError;
                                }
                            } catch (stockError) {
                                console.error(`Erro ao atualizar estoque:`, stockError);
                            }
                        }
                    }
                    
                    setCustomCase(null);
                    showToast(`Pedido #${order.id} salvo com sucesso!`, 'success');
                    // Espera um momento para garantir que o toast seja visto
                    setTimeout(() => {
                        navigateTo('manage-orders');
                    }, 1000);
                }
            } catch (error) {
                console.error('Error saving order:', error);
                showToast('Erro ao salvar o pedido: ' + error.message, 'danger');
            } finally {
                // Restaura o botão
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
                lucide.createIcons();
            }
        });
    }

    /** Remove a capinha personalizada da sessionStorage */
    window.removeCustomCase = function() {
        setCustomCase(null);
        showToast('Capinha personalizada removida do pedido.', 'warning');
        navigateTo('new-order'); 
    }

    /**
     * View C: Gerenciamento de Pedidos 
     */
    async function renderManageOrders() {
        try {
            // Busca os pedidos direto do Supabase
            const { data: orders, error } = await supabase
                .from('orders')
                .select('*, order_services(*)')
                .order('created_at', { ascending: false });

            if (error) {
                throw error;
            }

            // Build header content
            const headerContent = [
                '<div id="manage-orders-container">',
                '<h1 class="text-3xl font-bold text-text-dark mb-8">Gerenciamento de Pedidos (' + (orders ? orders.length : 0) + ' Total)</h1>',
                '<div class="mb-6 flex flex-col md:flex-row gap-4 items-center">',
                '<input type="text" id="order-search" placeholder="Buscar por ID, Cliente ou Modelo..." class="input-field w-full md:w-auto md:flex-1 md:max-w-md">',
                '<button onclick="renderView(\'manage-orders\')" class="btn-primary p-3 md:p-2 rounded-xl text-white font-semibold flex items-center justify-center md:justify-start w-full md:w-auto">',
                '<i data-lucide="rotate-ccw" class="w-4 h-4 mr-1"></i> Recarregar',
                '</button>',
                '</div>'
            ].join('\n');

            // Build table content
            const tableContent = [
                '<div class="card p-6 overflow-x-auto">',
                '<table class="min-w-full divide-y divide-gray-200">',
                '<thead class="bg-bg-light">',
                '<tr>',
                '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>',
                '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>',
                '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modelo</th>',
                '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serviços</th>',
                '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>',
                '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>',
                '<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>',
                '</tr>',
                '</thead>',
                '<tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">',
                orders && orders.length > 0 ? orders.map(order => renderOrderRow(order)).join('') : '<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhum pedido encontrado.</td></tr>',
                '</tbody>',
                '</table>',
                '</div>',
                '</div>'
            ].join('\n');

            return headerContent + tableContent;
        } catch (error) {
            console.error('Error fetching orders:', error);
            showToast('Erro ao carregar pedidos: ' + error.message, 'danger');
            return `
                <h1 class="text-3xl font-bold text-text-dark mb-8">Gerenciamento de Pedidos</h1>
                <div class="text-red-500">Erro ao carregar pedidos. Por favor, tente novamente.</div>
            `;
        }

        return `
            <div class="card p-6 overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-bg-light">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modelo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serviços</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                        ${orders && orders.length > 0 ? orders.map(order => renderOrderRow(order)).join('') : `
                            <tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhum pedido encontrado.</td></tr>
                        `}
                    </tbody>
                </table>
            </div>
        </div>
        `;
    }

    function renderOrderRow(order) {
        if (!order) return '';

        const statusMap = {
            'Aguardando Avaliação': 'yellow',
            'Em Reparo': 'primary-blue',
            'Concluído': 'green',
            'Cancelado': 'red',
        };
        const statusColor = statusMap[order.status] || 'gray';
        const date = order.created_at ? new Date(order.created_at).toLocaleDateString('pt-BR') : new Date().toLocaleDateString('pt-BR');
        
        // Garantir que order_services existe e é um array
        const services = order.order_services || [];
        const deviceModel = order.device_model || 'Não especificado';
        const clientName = order.client_name || 'Cliente não identificado';

        // Build services list
        const servicesList = services.map(s => '<li>' + (s.name || 'Serviço não especificado') + '</li>').join('');

        // Build status options
        const statusOptions = ['Aguardando Avaliação', 'Em Reparo', 'Concluído', 'Cancelado']
            .map(s => '<option value="' + s + '"' + (order.status === s ? ' selected' : '') + '>' + s + '</option>')
            .join('');

        // Build the row HTML
        const row = [
            '<tr data-order-id="' + order.id + '" data-search-terms="' + order.id + ' ' + clientName + ' ' + deviceModel + '">',
            '<td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-text-dark">#' + order.id + '</td>',
            '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">' + clientName + ' <span class="text-xs text-gray-400 block">' + date + '</span></td>',
            '<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">' + deviceModel + '</td>',
            '<td class="px-6 py-4 text-sm text-gray-700"><ul class="list-disc pl-4 text-xs">' + servicesList + '</ul></td>',
            '<td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-primary-blue">R$ ' + (order.total || 0).toFixed(2).replace('.', ',') + '</td>',
            '<td class="px-6 py-4 whitespace-nowrap">',
            '<select data-order-id="' + order.id + '" onchange="window.updateOrderStatus(' + order.id + ', this.value)" ',
            'class="p-2 rounded-lg text-xs font-semibold bg-' + statusColor + '-100 border border-' + statusColor + '-300 text-' + statusColor + '-700 focus:outline-none">',
            statusOptions,
            '</select>',
            '</td>',
            '<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">',
            '<button type="button" onclick="window.deleteOrder(' + order.id + ')" data-delete-order="' + order.id + '" ',
            'class="text-red-600 hover:text-red-900 ml-3 p-1 rounded-lg hover:bg-red-50" title="Excluir Pedido">',
            '<i data-lucide="trash" class="w-4 h-4"></i>',
            '</button>',
            '</td>',
            '</tr>'
        ].join('\n');

        return row;
    }

    function initializeManageOrdersLogic(allOrders) {
        // Aguarda o próximo ciclo do event loop para garantir que o DOM foi atualizado
        setTimeout(() => {
            const searchInput = document.getElementById('order-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#orders-table-body tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }

            // Adiciona evento de clique para a limpeza do campo de busca
            const clearSearchBtn = document.getElementById('clear-search');
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', () => {
                    const searchInput = document.getElementById('order-search');
                    if (searchInput) {
                        searchInput.value = '';
                        const event = new Event('input', { bubbles: true });
                        searchInput.dispatchEvent(event);
                    }
                });
            }
        }, 0);
    }

    window.updateOrderStatus = async function(orderId, newStatus) {
        try {
            // Desabilita o select durante a atualização
            const selectElement = document.querySelector(`select[data-order-id="${orderId}"]`);
            if (selectElement) {
                selectElement.disabled = true;
                // Adiciona um efeito visual de loading
                selectElement.classList.add('opacity-50');
            }

            // Atualiza o status no banco de dados
            const { data, error } = await supabase
                .from('orders')
                .update({ status: newStatus })
                .eq('id', orderId)
                .select()
                .single();

            if (error) throw error;

            // Atualiza o visual do select
            if (selectElement) {
                const statusColor = getStatusColor(newStatus);
                selectElement.className = `p-2 rounded-lg text-xs font-semibold bg-${statusColor}-100 border border-${statusColor}-300 text-${statusColor}-700 focus:outline-none`;
                selectElement.classList.remove('opacity-50');
                selectElement.disabled = false;
            }

            showToast(`Status do Pedido #${orderId} alterado para "${newStatus}"!`, 'success');
        } catch (error) {
            console.error('Error updating order status:', error);
            showToast('Erro ao atualizar status do pedido: ' + error.message, 'danger');
            
            // Restaura o select em caso de erro
            const selectElement = document.querySelector(`select[data-order-id="${orderId}"]`);
            if (selectElement) {
                selectElement.disabled = false;
                selectElement.classList.remove('opacity-50');
            }
        }
    }

    window.deleteOrder = function(orderId) {
        if (!window.supabase) {
            showToast('Conexão com Supabase não inicializada', 'danger');
            return;
        }
        showModal('Confirmação de Exclusão', `Tem certeza que deseja excluir o Pedido #${orderId}? Esta ação não pode ser desfeita.`, async () => {
            try {
                // Desabilita o botão durante a exclusão
                const deleteButton = document.querySelector(`button[data-delete-order="${orderId}"]`);
                if (deleteButton) {
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i>`;
                    lucide.createIcons();
                }

                // Primeiro deleta os serviços relacionados
                await supabase
                    .from('order_services')
                    .delete()
                    .eq('order_id', orderId);

                // Depois deleta o pedido
                const { error } = await supabase
                    .from('orders')
                    .delete()
                    .eq('id', orderId);

                if (error) throw error;
                
                showToast(`Pedido #${orderId} excluído com sucesso.`, 'success');
                await getData(); // Atualiza os dados gerais
                renderView('manage-orders'); // Recarrega a view
            } catch (error) {
                console.error('Error deleting order:', error);
                showToast('Erro ao excluir pedido: ' + error.message, 'danger');
                
                // Restaura o botão em caso de erro
                const deleteButton = document.querySelector(`button[data-delete-order="${orderId}"]`);
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i>`;
                    lucide.createIcons();
                }
            }
        });
    }

    /**
     * View D: Controle de Estoque
     */
    function renderStockControl(stock) {
        return `
            <h1 class="text-3xl font-bold text-text-dark mb-8">Controle de Estoque</h1>
            
            <!-- Flex quebra para coluna em telas pequenas (lg:flex-row) -->
            <div class="flex flex-col lg:flex-row gap-6 mb-8">
                <!-- Coluna Adicionar Item (lg:w-1/3) -->
                <div class="card p-6 lg:w-1/3">
                    <h2 class="text-xl font-semibold mb-4 text-text-dark border-b pb-2 flex items-center">
                        <i data-lucide="package" class="w-5 h-5 mr-2 text-primary-blue"></i> Adicionar Novo Item
                    </h2>
                    <form id="add-stock-form" class="space-y-4">
                        <div>
                            <label for="item-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Item</label>
                            <input type="text" id="item-name" required class="input-field w-full">
                        </div>
                        <div>
                            <label for="item-quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantidade Inicial</label>
                            <input type="number" id="item-quantity" required min="1" value="1" class="input-field w-full">
                        </div>
                        <div>
                            <label for="item-cost" class="block text-sm font-medium text-gray-700 mb-1">Custo Unitário (R$)</label>
                            <input type="number" id="item-cost" required min="0.01" step="0.01" value="10.00" class="input-field w-full">
                        </div>
                        <div>
                            <label for="item-compatible-model" class="block text-sm font-medium text-gray-700 mb-1">Modelo Compatível (Ex: iPhone 14)</label>
                            <input type="text" id="item-compatible-model" class="input-field w-full">
                        </div>
                        <button type="submit" class="btn-primary w-full p-3 rounded-xl text-white font-semibold flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Adicionar Item
                        </button>
                    </form>
                </div>

                <!-- Coluna Lista de Estoque (lg:w-2/3) -->
                <div class="card p-6 lg:w-2/3">
                    <h2 class="text-xl font-semibold mb-4 text-text-dark border-b pb-2">Lista de Estoque</h2>
                    <input type="text" id="stock-search" placeholder="Filtrar por nome ou modelo..." class="input-field w-full mb-4">
                    <!-- Tabela encapsulada em overflow-x-auto para responsividade -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-bg-light">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modelo Comp.</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd.</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Custo Unitário</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="stock-table-body" class="bg-white divide-y divide-gray-200">
                                ${(stock && stock.length > 0) ? stock.map((item, index) => renderStockRow(item, index)).join('') : `
                                    <tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhum item em estoque.</td></tr>
                                `}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    function renderStockRow(item, index) {
        const lowStockClass = item.quantity <= 5 ? 'bg-red-100 text-red-600 font-bold' : '';
        return `
            <tr data-stock-index="${index}" data-stock-id="${item.id}" data-search-terms="${item.name} ${item.compatibleModel}">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-text-dark">${item.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item.compatibleModel || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-center ${lowStockClass}">
                    ${item.quantity}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">R$ ${item.cost.toFixed(2).replace('.', ',')}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button 
                        type="button"
                        onclick="deleteStockItem(${item.id})" 
                        data-delete-stock="${item.id}"
                        class="text-red-600 hover:text-red-900 p-1 rounded-lg hover:bg-red-50" 
                        title="Remover Item">
                        <i data-lucide="trash" class="w-4 h-4"></i>
                    </button>
                </td>
            </tr>
        `;
    }

    function initializeStockLogic() {
        const form = document.getElementById('add-stock-form');
        const searchInput = document.getElementById('stock-search');
        const tableBody = document.getElementById('stock-table-body');

        if (!form || !searchInput || !tableBody) {
            console.error('Elementos do estoque não encontrados');
            return;
        }

        let isLoadingStock = false;
        let currentStockItems = [];

        // Função para filtrar itens do estoque
        function filterStockItems(searchTerm) {
            if (!searchTerm) {
                // Se não houver termo de busca, mostra todos os itens
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(row => row.style.display = '');
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                // Pula a linha de mensagem de estoque vazio
                if (row.querySelector('td[colspan]')) {
                    return;
                }
                
                const name = row.cells[0].textContent.toLowerCase();
                const model = row.cells[1].textContent.toLowerCase();
                
                if (name.includes(searchLower) || model.includes(searchLower)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Adiciona o evento de busca
        searchInput.addEventListener('input', (e) => {
            filterStockItems(e.target.value.trim());
        });

        // Atualiza a lista de estoque diretamente do Supabase
        async function updateStockList() {
            if (isLoadingStock) return [];
            
            try {
                isLoadingStock = true;
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-gray-500">
                            <i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto mb-2"></i>
                            Carregando estoque...
                        </td>
                    </tr>
                `;
                lucide.createIcons();

                if (!supabase) {
                    throw new Error('Conexão com Supabase não inicializada');
                }

                const { data, error } = await supabase
                    .from('stock')
                    .select('*')
                    .order('name', { ascending: true });
                
                // Salva os itens atuais para uso na filtragem
                currentStockItems = data || [];

                if (error) {
                    throw new Error(`Erro do Supabase: ${error.message}`);
                }
                
                if (error) {
                    throw error;
                }

                return data || [];
            } catch (error) {
                console.error('Erro ao carregar estoque:', error);
                showToast(`Erro ao carregar estoque: ${error.message}`, 'danger');
                return [];
            } finally {
                isLoadingStock = false;
            }
        }
        
        // Carrega e atualiza a lista de estoque
        function updateTableContent(stock) {
            if (!tableBody) return;
            
            tableBody.innerHTML = stock.length > 0 ? stock.map((item, index) => renderStockRow(item, index)).join('') : `
                <tr><td colspan="5" class="text-center py-4 text-gray-500">Nenhum item em estoque.</td></tr>
            `;
            lucide.createIcons();
        }

        // Carrega o estoque inicial
        updateStockList().then(updateTableContent);

        // Torna as funções globais
        window.updateStockList = updateStockList;
        window.filterStockItems = filterStockItems;

        let isSubmitting = false;
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Previne duplo clique e submissões simultâneas
            if (isSubmitting) {
                showToast('Aguarde, item sendo adicionado...', 'warning');
                return;
            }
            
            // Desabilita o botão de submit
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <i data-lucide="loader" class="w-5 h-5 animate-spin mr-2"></i>
                Adicionando...
            `;
            lucide.createIcons();

            try {
                isSubmitting = true;
                const newItem = {
                    name: document.getElementById('item-name').value.trim(),
                    quantity: parseInt(document.getElementById('item-quantity').value),
                    cost: parseFloat(document.getElementById('item-cost').value),
                    compatibleModel: document.getElementById('item-compatible-model').value.trim() || null,
                };
                
                await saveStockItem(newItem);
                form.reset();
                
                // Atualiza a lista de estoque sem recarregar a página
                const stock = await updateStockList();
                updateTableContent(stock);
                
            } catch (error) {
                console.error('Error saving stock item:', error);
                showToast('Erro ao adicionar item: ' + error.message, 'danger');
            } finally {
                // Restaura o botão
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
                lucide.createIcons();
                isSubmitting = false;
            }
        });

        // Função para filtrar itens do estoque
        function filterStockItems(searchTerm) {
            if (!searchTerm) {
                // Se não houver termo de busca, mostra todos os itens
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(row => row.style.display = '');
                return;
            }

            const searchLower = searchTerm.toLowerCase();
            const rows = tableBody.querySelectorAll('tr');
            let hasVisibleRows = false;
            
            rows.forEach(row => {
                // Pula a linha de mensagem de estoque vazio
                if (row.querySelector('td[colspan]')) {
                    return;
                }
                
                const name = row.cells[0].textContent.toLowerCase();
                const model = row.cells[1].textContent.toLowerCase();
                
                if (name.includes(searchLower) || model.includes(searchLower)) {
                    row.style.display = '';
                    hasVisibleRows = true;
                } else {
                    row.style.display = 'none';
                }
            });

            // Mostra mensagem se nenhum item for encontrado
            const noItemsRow = tableBody.querySelector('tr[data-no-items]');
            if (noItemsRow) {
                noItemsRow.style.display = hasVisibleRows ? 'none' : '';
            }
        }

        // Adiciona o evento de busca
        searchInput.addEventListener('input', (e) => {
            filterStockItems(e.target.value.trim());
        });
    }

    window.deleteStockItem = function(itemId) {
        console.log('window.deleteStockItem chamada com itemId:', itemId); // DEBUG
        if (!window.supabase) {
            showToast('Conexão com Supabase não inicializada', 'danger');
            return;
        }
        showModal('Confirmação de Exclusão', `Tem certeza que deseja remover este item do estoque? Esta ação não pode ser desfeita.`, async () => {
            try {
                // Desabilita o botão durante a exclusão
                const deleteButton = document.querySelector(`button[data-delete-stock="${itemId}"]`);
                if (deleteButton) {
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i>`;
                    lucide.createIcons();
                }

                const { error } = await supabase
                    .from('stock')
                    .delete()
                    .eq('id', itemId);

                if (error) throw error;
                
                showToast('Item removido do estoque com sucesso.', 'success');
                await updateStockList(); // Atualiza a lista após deletar
            } catch (error) {
                console.error('Error deleting stock item:', error);
                showToast('Erro ao remover item: ' + error.message, 'danger');
                
                // Restaura o botão em caso de erro
                const deleteButton = document.querySelector(`button[data-delete-stock="${itemId}"]`);
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i>`;
                    lucide.createIcons();
                }
            }
        });
    }
    
    /**
     * View E: Capinhas Personalizadas 
     */
    function renderCustomCases() {
        return `
            <h1 class="text-3xl font-bold text-text-dark mb-8">Capinhas Personalizadas (Customizador)</h1>
            <!-- Flex quebra para coluna em telas pequenas (lg:flex-row) -->
            <div class="card p-8 flex flex-col lg:flex-row items-center lg:items-start lg:justify-center gap-12">
                
                <!-- 1. Visualização do Phone Frame -->
                <div class="flex flex-col items-center">
                    <h2 class="text-xl font-semibold mb-4 text-text-dark">Pré-visualização</h2>
                    <div class="phone-frame">
                        <div id="phone-case-preview" class="phone-case" style="background-color: #3b82f6;"></div>
                    </div>
                    <p id="selected-color-name" class="mt-4 text-sm font-medium text-gray-600">Cor Atual: Azul Gelo</p>
                </div>
                
                <!-- 2. Opções de Customização -->
                <div class="w-full lg:w-1/2 mt-8 lg:mt-0">
                    <form id="custom-case-form" class="space-y-6">
                        
                        <!-- Seleção do Tipo -->
                        <div class="card p-5 bg-bg-light">
                            <h3 class="text-lg font-semibold mb-3 text-text-dark">Tipo de Capinha</h3>
                            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="case-type" value="Normal" data-price="20.00" checked class="w-4 h-4 text-primary-blue focus:ring-primary-blue">
                                    <span class="ml-2 font-medium text-gray-700">Normal (Vibrante) - R$ 20,00</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="case-type" value="Pastel" data-price="30.00" class="w-4 h-4 text-primary-blue focus:ring-primary-blue">
                                    <span class="ml-2 font-medium text-gray-700">Pastel (Premium) - R$ 30,00</span>
                                </label>
                            </div>
                        </div>

                        <!-- Paleta de Cores -->
                        <div class="card p-5 bg-bg-light">
                            <h3 class="text-lg font-semibold mb-3 text-text-dark">Selecione a Cor</h3>
                            <!-- Ajustado para 6 colunas para manter a paleta compacta e com mais cores -->
                            <div id="color-palette" class="grid grid-cols-6 gap-3">
                                <!-- Cores serão injetadas aqui -->
                            </div>
                        </div>

                        <!-- Botão de Ação -->
                        <button type="submit" class="btn-primary w-full p-3 rounded-xl text-white font-semibold flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> Adicionar ao Pedido (R$ <span id="case-price-display">20,00</span>)
                        </button>
                    </form>
                </div>
            </div>
        `;
    }

    function initializeCustomCasesLogic() {
        const preview = document.getElementById('phone-case-preview');
        const paletteContainer = document.getElementById('color-palette');
        const form = document.getElementById('custom-case-form');
        const priceDisplay = document.getElementById('case-price-display');
        const colorNameDisplay = document.getElementById('selected-color-name');

        let selectedColorHex = '#3b82f6';
        let selectedColorName = 'Azul Gelo';
        let selectedPrice = 20.00;

        const palettes = {
            Normal: [
                { name: 'Azul Gelo (Padrão)', hex: '#3b82f6' },
                { name: 'Vermelho Fogo', hex: '#dc2626' },
                { name: 'Amarelo Limão', hex: '#eab308' },
                { name: 'Verde Floresta', hex: '#16a34a' },
                { name: 'Azul Elétrico', hex: '#2563eb' },
                { name: 'Roxo Ultravioleta', hex: '#7c3aed' },
                { name: 'Preto Matte', hex: '#171717' },
                { name: 'Branco Puro', hex: '#fefefe' },
                { name: 'Cinza Carvão', hex: '#374151' },
                { name: 'Dourado Escuro', hex: '#ca8a04' },
                { name: 'Prata Espacial', hex: '#94a3b8' },
                { name: 'Cobre Brilhante', hex: '#b45309' },
            ],
            Pastel: [
                { name: 'Rosa Quartzo', hex: '#fbcfe8' },
                { name: 'Azul Serenidade', hex: '#bfdbfe' },
                { name: 'Verde Água', hex: '#a7f3d0' },
                { name: 'Amarelo Creme', hex: '#fde68a' },
                { name: 'Lavanda Suave', hex: '#d8b4fe' },
                { name: 'Pêssego Claro', hex: '#fed7aa' },
                { name: 'Cinza Névoa', hex: '#d1d5db' },
                { name: 'Coral Suave', hex: '#fca5a5' },
                { name: 'Turquesa Opaco', hex: '#67e8f9' },
                { name: 'Verde Oliva Claro', hex: '#d9f99d' },
                { name: 'Laranja Salmão', hex: '#fda4af' },
                { name: 'Branco Giz', hex: '#f5f5f4' },
            ]
        };

        /** Renderiza a paleta de cores baseada no tipo selecionado. */
        function renderPalette(type) {
            const palette = palettes[type];
            paletteContainer.innerHTML = palette.map(color => `
                <div data-hex="${color.hex}" data-name="${color.name}" class="w-full h-8 rounded-lg cursor-pointer transform hover:scale-110 transition-transform duration-150 border-2 border-transparent ${color.hex === selectedColorHex ? 'border-primary-blue' : ''}" style="background-color: ${color.hex}" title="${color.name}"></div>
            `).join('');
            attachPaletteListeners();
        }

        /** Atualiza a pré-visualização e variáveis. */
        function updatePreview(hex, name) {
            selectedColorHex = hex;
            selectedColorName = name;
            preview.style.backgroundColor = hex;
            colorNameDisplay.textContent = `Cor Atual: ${name}`;
            
            // Atualiza a seleção visual na paleta
            document.querySelectorAll('#color-palette > div').forEach(el => {
                el.classList.remove('border-primary-blue');
                el.classList.add('border-transparent');
                if (el.getAttribute('data-hex') === hex) {
                    el.classList.add('border-primary-blue');
                }
            });
        }

        /** Adiciona listeners para cliques nas cores. */
        function attachPaletteListeners() {
            document.querySelectorAll('#color-palette > div').forEach(colorDiv => {
                colorDiv.addEventListener('click', () => {
                    updatePreview(colorDiv.getAttribute('data-hex'), colorDiv.getAttribute('data-name'));
                });
            });
        }

        // Listener para mudança de Tipo
        document.querySelectorAll('input[name="case-type"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const type = e.target.value;
                selectedPrice = parseFloat(e.target.getAttribute('data-price'));
                priceDisplay.textContent = selectedPrice.toFixed(2).replace('.', ',');
                
                // Força a seleção para a primeira cor da nova paleta
                const newPalette = palettes[type];
                updatePreview(newPalette[0].hex, newPalette[0].name);
                renderPalette(type);
            });
        });

        // Submissão do Formulário
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const caseType = document.querySelector('input[name="case-type"]:checked').value;
            
            const customCase = {
                type: caseType,
                color: selectedColorName,
                hex: selectedColorHex,
                price: selectedPrice,
            };
            
            setCustomCase(customCase);
            navigateTo('new-order');
        });

        // Inicialização
        updatePreview(selectedColorHex, selectedColorName);
        renderPalette('Normal');
    }

    /**
     * View F: Administração do Sistema 
     */
    function renderAdmin(models, services) {
        return `
            <h1 class="text-3xl font-bold text-text-dark mb-8">Administração do Sistema</h1>
            
            <!-- Grid ajustado para 1 coluna em telas pequenas e 2 em telas grandes -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- Gerenciar Modelos -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-text-dark border-b pb-2 flex items-center">
                        <i data-lucide="layout-grid" class="w-5 h-5 mr-2 text-primary-blue"></i> Gerenciar Marcas/Modelos
                    </h2>
                    
                    <form id="add-model-form" class="space-y-4 mb-6">
                        <div>
                            <label for="new-brand" class="block text-sm font-medium text-gray-700 mb-1">Nova Marca</label>
                            <input type="text" id="new-brand" required class="input-field w-full">
                        </div>
                        <div>
                            <label for="new-model-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Modelo (Ex: iPhone 15 Pro)</label>
                            <input type="text" id="new-model-name" required class="input-field w-full">
                        </div>
                        <button type="submit" class="btn-primary w-full p-2 rounded-xl text-white font-semibold">Adicionar Modelo</button>
                    </form>
                    
                    <h3 class="font-semibold mt-6 mb-3 text-text-dark">Modelos Cadastrados</h3>
                    <div id="models-list" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        ${models.map((m, index) => renderModelItem(m, index)).join('')}
                    </div>
                </div>

                <!-- Gerenciar Serviços e Preços -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-text-dark border-b pb-2 flex items-center">
                        <i data-lucide="wrench" class="w-5 h-5 mr-2 text-primary-blue"></i> Gerenciar Serviços & Preços
                    </h2>

                    <form id="add-service-form" class="space-y-4 mb-6">
                        <div>
                            <label for="new-service-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Serviço</label>
                            <input type="text" id="new-service-name" required class="input-field w-full">
                        </div>
                        <div>
                            <label for="new-service-price" class="block text-sm font-medium text-gray-700 mb-1">Preço Inicial (R$)</label>
                            <input type="number" id="new-service-price" required min="0.01" step="0.01" class="input-field w-full" value="50.00">
                        </div>
                        <button type="submit" class="btn-primary w-full p-2 rounded-xl text-white font-semibold">Adicionar Serviço</button>
                    </form>

                    <h3 class="font-semibold mt-6 mb-3 text-text-dark">Serviços Existentes</h3>
                    <div id="services-list" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                        ${services.map((s, index) => renderServiceItem(s, index)).join('')}
                    </div>
                </div>
            </div>
        `;
    }

    /** Renderiza um item de modelo na administração */
    function renderModelItem(model) {
        if (!model || !model.id) return '';
        return `
            <div class="flex justify-between items-center p-3 bg-bg-light rounded-lg text-sm">
                <span>${model.brand} - ${model.name}</span>
                <button 
                    type="button"
                    onclick="window.deleteModel(${model.id})" 
                    data-delete-model="${model.id}"
                    class="text-red-600 hover:text-red-800 p-1 rounded-lg hover:bg-red-50" 
                    title="Remover Modelo">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `;
    }

    /** Renderiza um item de serviço com edição inline de preço */
    function renderServiceItem(service) {
        if (!service || !service.id) return '';
        return `
            <div class="flex justify-between items-center p-3 bg-bg-light rounded-lg text-sm">
                <span class="font-medium text-text-dark">${service.name}</span>
                <div class="flex items-center space-x-2">
                    <input type="number" data-service-id="${service.id}" value="${service.price.toFixed(2)}" min="0.01" step="0.01" class="service-price-input w-24 p-1.5 rounded-lg border-gray-300 text-right text-text-dark text-sm">
                    <button 
                        type="button"
                        onclick="window.saveServicePrice(${service.id})" 
                        class="text-primary-blue hover:text-secondary-blue font-semibold text-xs py-1 px-2 rounded-lg bg-white shadow-sm hover:bg-blue-50" 
                        title="Salvar Preço">
                        <i data-lucide="save" class="w-4 h-4"></i>
                    </button>
                    <button 
                        type="button"
                        onclick="window.deleteService(${service.id})" 
                        data-delete-service="${service.id}"
                        class="text-red-600 hover:text-red-800 ml-2 p-1 rounded-lg hover:bg-red-50" 
                        title="Remover Serviço">
                        <i data-lucide="trash" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        `;
    }

    // Variáveis globais para armazenar os dados atuais
    let currentModels = [];
    let currentServices = [];

    // Função global para atualizar a lista de modelos
    async function updateModelsList() {
        try {
            const { data: models, error } = await supabase
                .from('models')
                .select('*')
                .order('brand', { ascending: true });

            if (error) throw error;
            currentModels = models || [];
            const modelsList = document.getElementById('models-list');
            if (modelsList) {
                modelsList.innerHTML = currentModels.map(m => renderModelItem(m)).join('');
                lucide.createIcons();
            }
        } catch (error) {
            console.error('Error fetching models:', error);
            showToast('Erro ao carregar modelos', 'danger');
        }
    }

    // Função global para atualizar a lista de serviços
    async function updateServicesList() {
        try {
            const { data: services, error } = await supabase
                .from('services')
                .select('*')
                .order('name', { ascending: true });

            if (error) throw error;
            currentServices = services || [];
            const servicesList = document.getElementById('services-list');
            if (servicesList) {
                servicesList.innerHTML = currentServices.map(s => renderServiceItem(s)).join('');
                lucide.createIcons();
            }
        } catch (error) {
            console.error('Error fetching services:', error);
            showToast('Erro ao carregar serviços', 'danger');
        }
    }

    function initializeAdminLogic() {
        // Carregar listas iniciais
        updateModelsList();
        updateServicesList();

        // Lógica de Adicionar Modelo
        document.getElementById('add-model-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin mr-2"></i> Salvando...`;
            lucide.createIcons();

            const newBrand = document.getElementById('new-brand').value.trim();
            const newModelName = document.getElementById('new-model-name').value.trim();
            
            try {
                if (newBrand && newModelName) {
                    const model = await saveModel({ brand: newBrand, name: newModelName });
                    if (model) {
                        e.target.reset();
                        await updateModelsList();
                    }
                }
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
                lucide.createIcons();
            }
        });

        // Lógica de Adicionar Serviço
        document.getElementById('add-service-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin mr-2"></i> Salvando...`;
            lucide.createIcons();

            const newServiceName = document.getElementById('new-service-name').value.trim();
            const newServicePrice = parseFloat(document.getElementById('new-service-price').value);
            
            try {
                if (newServiceName && !isNaN(newServicePrice) && newServicePrice > 0) {
                    const service = await saveService({ name: newServiceName, price: newServicePrice });
                    if (service) {
                        e.target.reset();
                        await updateServicesList();
                    }
                }
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalText;
                lucide.createIcons();
            }
        });
    }

    window.deleteModel = function(modelId) {
        if (!window.supabase) {
            showToast('Conexão com Supabase não inicializada', 'danger');
            return;
        }
        showModal('Confirmação de Exclusão', `Tem certeza que deseja remover este modelo? Esta ação não pode ser desfeita.`, async () => {
            try {
                // Desabilita o botão durante a exclusão
                const deleteButton = document.querySelector(`button[data-delete-model="${modelId}"]`);
                if (deleteButton) {
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i>`;
                    lucide.createIcons();
                }

                const { error } = await supabase
                    .from('models')
                    .delete()
                    .eq('id', modelId);

                if (error) throw error;
                
                showToast('Modelo removido com sucesso.', 'success');
                await updateModelsList(); // Atualiza a lista após deletar
            } catch (error) {
                console.error('Error deleting model:', error);
                showToast('Erro ao remover modelo: ' + error.message, 'danger');
                
                // Restaura o botão em caso de erro
                const deleteButton = document.querySelector(`button[data-delete-model="${modelId}"]`);
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = `<i data-lucide="trash" class="w-4 h-4"></i>`;
                    lucide.createIcons();
                }
            }
        });
    }

    window.saveServicePrice = async function(serviceId) {
        const inputElement = document.querySelector(`.service-price-input[data-service-id="${serviceId}"]`);
        const newPrice = parseFloat(inputElement.value);

        if (isNaN(newPrice) || newPrice <= 0) {
            showToast('Preço inválido.', 'warning');
            return;
        }

        try {
            const { data, error } = await supabase
                .from('services')
                .update({ price: newPrice })
                .eq('id', serviceId)
                .select()
                .single();

            if (error) throw error;
            showToast(`Preço atualizado para R$ ${newPrice.toFixed(2).replace('.', ',')}!`, 'success');
            await updateServicesList(); // Atualiza a lista após salvar
        } catch (error) {
            console.error('Error updating service price:', error);
            showToast('Erro ao atualizar preço: ' + error.message, 'danger');
        }
    }

    window.deleteService = function(serviceId) {
        if (!window.supabase) {
            showToast('Conexão com Supabase não inicializada', 'danger');
            return;
        }
        showModal('Confirmação de Exclusão', `Tem certeza que deseja remover este serviço? Esta ação não pode ser desfeita.`, async () => {
            try {
                // Desabilita o botão durante a exclusão
                const deleteButton = document.querySelector(`button[data-delete-service="${serviceId}"]`);
                if (deleteButton) {
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i>`;
                    lucide.createIcons();
                }

                const { error } = await supabase
                    .from('services')
                    .delete()
                    .eq('id', serviceId);

                if (error) throw error;
                
                showToast('Serviço removido com sucesso.', 'success');
                await updateServicesList(); // Atualiza a lista após deletar
            } catch (error) {
                console.error('Error deleting service:', error);
                showToast('Erro ao remover serviço: ' + error.message, 'danger');
                
                // Restaura o botão em caso de erro
                const deleteButton = document.querySelector(`button[data-delete-service="${serviceId}"]`);
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = `<i data-lucide="trash" class="w-4 h-4"></i>`;
                    lucide.createIcons();
                }
            }
        });
    }

    // Tornando as funções de atualização disponíveis globalmente
    window.updateModelsList = updateModelsList;
    window.updateServicesList = updateServicesList;

    // --- Lógica da Modal Customizada (Substitui confirm()) ---
    let modalCallback = null;
    const modal = document.getElementById('custom-modal');
    
    function showModal(title, body, confirmAction) {
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        if (modalTitle) modalTitle.textContent = title;
        if (modalBody) modalBody.textContent = body;
        modalCallback = confirmAction;
        if (modal) {
            modal.classList.remove('hidden');
            modal.style.display = 'flex'; // Garante que o modal aparece
            console.log('Modal exibido!'); // DEBUG
        } else {
            console.error('Elemento custom-modal não encontrado!');
        }
    }

    function hideModal() {
        const modal = document.getElementById('custom-modal');
        if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none'; // Garante que o modal realmente suma
            // Força reflow para garantir que o modal desapareça
            void modal.offsetWidth;
        }
        modalCallback = null;
        // Remove foco de qualquer botão do modal
        const cancelBtn = document.getElementById('modal-cancel-btn');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        if (cancelBtn) cancelBtn.blur();
        if (confirmBtn) confirmBtn.blur();
    }

    // Inicializa a modal
    document.addEventListener('DOMContentLoaded', () => {
        const cancelBtn = document.getElementById('modal-cancel-btn');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
        if (confirmBtn) confirmBtn.addEventListener('click', () => {
            if (modalCallback) {
                modalCallback();
            }
            hideModal();
        });
        // Permite fechar o modal ao clicar no fundo (overlay) - mouse e toque
        const modalOverlay = document.getElementById('custom-modal');
        if (modalOverlay) {
            // Mouse
            modalOverlay.addEventListener('mousedown', function(e) {
                if (e.target === modalOverlay) {
                    hideModal();
                }
            });
            // Toque (dedo)
            modalOverlay.addEventListener('touchstart', function(e) {
                if (e.target === modalOverlay) {
                    hideModal();
                }
            });
        }
    });

    // --- Inicialização da Aplicação ---
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Inicializa os elementos DOM primeiro
            initializeDOMElements();
            
            if (!contentWrapper) {
                throw new Error('Elemento contentWrapper não encontrado. A aplicação não pode continuar.');
            }

            // Testa a conexão com o Supabase primeiro
            const { data, error } = await supabase.from('models').select('count');
            if (error) throw error;

            // Se a conexão estiver ok, inicializa a aplicação
            initializeData();

            // Configura a navegação
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = e.currentTarget.getAttribute('data-view');
                    navigateTo(view);
                });
            });

            // Inicializa os ícones Lucide
            lucide.createIcons();
            
            // Renderiza a view inicial
            renderView('dashboard');

            // Inicia na Dashboard e ativa o link
            const initialLink = document.querySelector('.nav-link[data-view="dashboard"]');
            if (initialLink) {
                initialLink.classList.add('active');
        
                // Ativa o estilo moderno no dock ao iniciar (Desktop)
                if (window.innerWidth >= 768) {
                    // Remove as classes de cor de texto padrão Tailwind, pois o CSS customizado já define.
                    initialLink.classList.remove('text-text-dark'); 
                    
                    // Adiciona o estilo ativo moderno
                    initialLink.classList.add('bg-white/30'); 
                    initialLink.style.color = 'var(--color-primary)';
                    // Aplica o brilho e o inset-shadow
                    initialLink.style.boxShadow = '0 0 15px rgba(59, 130, 246, 0.8), inset 0 0 5px rgba(255, 255, 255, 0.6)'; 
                }
            }
        } catch (error) {
            console.error('Error initializing application:', error);
            showToast('Erro ao inicializar a aplicação: ' + error.message, 'danger');
        }
    });

    // Garante que o estado da sidebar seja reajustado ao mudar o tamanho da tela
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
            // Em desktop, garante que o dock está no lugar e o overlay escondido
            sidebar.classList.remove('open');
            sidebarOverlay.classList.add('hidden');
            menuIcon.setAttribute('data-lucide', 'menu'); 
            
            // Re-aplica classes de cor no dock (porque o resize pode limpar)
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-white/30');
                link.style.boxShadow = 'none';
                link.style.color = 'rgba(255, 255, 255, 0.9)';
                
                if (link.classList.contains('active')) {
                    link.classList.add('bg-white/30');
                    link.style.color = 'var(--color-primary)';
                    link.style.boxShadow = '0 0 15px rgba(59, 130, 246, 0.8), inset 0 0 5px rgba(255, 255, 255, 0.6)'; 
                }
            });

            lucide.createIcons();
        }
    });

    // Delegação de clique para ícones de lixeira (orders / stock)
    function attachTrashClickDelegation() {
        document.addEventListener('click', (e) => {
            // Procura por qualquer elemento (botão, ícone, link) que tenha os atributos data-delete-order ou data-delete-stock
            const target = e.target.closest('[data-delete-order], [data-delete-stock], button[data-delete-order], button[data-delete-stock]');
            if (!target) return;

            const orderId = target.getAttribute('data-delete-order');
            const stockId = target.getAttribute('data-delete-stock');

            console.log('Ícone de lixeira clicado:', { orderId, stockId });

            // Chama as funções globais (window) para garantir escopo correto
            if (orderId) {
                if (typeof window.deleteOrder === 'function') {
                    try {
                        window.deleteOrder(Number(orderId));
                    } catch (err) {
                        console.error('Erro ao chamar window.deleteOrder:', err);
                    }
                } else {
                    console.warn('window.deleteOrder não está definida');
                }
            }

            if (stockId) {
                if (typeof window.deleteStockItem === 'function') {
                    try {
                        window.deleteStockItem(Number(stockId));
                    } catch (err) {
                        console.error('Erro ao chamar window.deleteStockItem:', err);
                    }
                } else {
                    console.warn('window.deleteStockItem não está definida');
                }
            }
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachTrashClickDelegation);
    } else {
        attachTrashClickDelegation();
    }
</script>

<!-- Modal para Confirmações (sempre presente no DOM) -->
<div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
        <h3 id="modal-title" class="text-xl font-bold mb-4 text-text-dark"></h3>
        <p id="modal-body" class="mb-6 text-gray-700"></p>
        <div class="flex justify-end space-x-3">
            <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
            <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold">Confirmar</button>
        </div>
    </div>
</div>

</body>
</html>
